name: Build and Test (Production)

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set Up Go
      uses: actions/setup-go@v4
      with:
        go-version: 1.23

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y make python3 python3-pip ffmpeg yt-dlp
        sudo apt-get clean

    - name: Start Server
      run: |
        nohup go run main.go > server.log 2>&1 &

    - name: Run Build-Prod
      run: make build-prod
      timeout-minutes: 10 

    - name: Stop Server
      run: |
        pkill -f "go run main.go"

    - name: Trigger CapRover Deployment
      if: success() # Runs only if the build and tests succeed
      run: |
        curl -X POST "https://captain.mormor.online/api/v2/user/apps/webhooks/triggerbuild?namespace=captain&token=${{ secrets.CAPROVER_WEBHOOK_TOKEN }}"